<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace - CampusCore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="../assets/icons/favicon.ico">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar.is-open { transform: translateX(0); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .loading-spinner { border: 4px solid #f3f4f6; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .loading-overlay { position: fixed; inset: 0; background-color: rgba(255, 255, 255, 0.9); display: none; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.3s; }
        .hidden { display: none !important; } /* Use !important for simpler show/hide */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Modals */
        .cart-modal-overlay, .checkout-modal-overlay { transition: opacity 0.3s, visibility 0.3s; z-index: 40; }
        .checkout-modal-overlay { z-index: 50; }
        .cart-modal, .checkout-modal { transition: transform 0.3s ease-in-out; z-index: 51; }
        .cart-badge { transition: transform 0.2s ease-out; }
        /* Toast Notification */
        .toast-notification { transition: transform 0.4s ease-in-out, opacity 0.4s; z-index: 60; }
        /* Disable interaction during loading */
        body.loading-active { pointer-events: none; }
        body.loading-active #loading { display: flex; pointer-events: all; } /* Ensure loading shows */
        .invisible-overlay { visibility: hidden; opacity: 0; }
        .visible-overlay { visibility: visible; opacity: 1; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="loading" class="loading-overlay hidden"> <div class="loading-spinner"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-[260px_1fr] h-screen">
        <aside id="student-sidebar" class="bg-white border-r border-gray-200 flex flex-col fixed inset-y-0 left-0 w-64 z-30 transform -translate-x-full md:translate-x-0 md:static">
             <div class="px-6 py-4 border-b border-gray-200">
                <a href="dashboard.html" class="text-2xl font-bold text-indigo-600">CampusCore</a>
            </div>
            <nav class="flex-grow p-4 space-y-1">
                <a href="dashboard.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900"> <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg> Dashboard </a>
                <a href="announcements.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900"> <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.144-6.126A.75.75 0 015.5 12.632v-1.264a.75.75 0 01.621-.74l6.164-1.898a.75.75 0 01.88 0l6.164 1.898a.75.75 0 01.621.74v1.264a.75.75 0 01-.121.402l-2.144 6.126A1.76 1.76 0 0113 19.24V5.882" /></svg> Announcements </a>
                <a href="events.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900"> <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> Events </a>
                <a href="resources.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900"> <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg> Resources </a>
                <a href="lost-found.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900"> <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 10.5a.5.5 0 01.5-.5h3a.5.5 0 010 1h-3a.5.5 0 01-.5-.5z" /></svg> Lost & Found </a>
                <a href="marketplace.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md bg-indigo-600 text-white"> <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg> Marketplace </a>
                <a href="my-orders.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2h2a2 2 0 002 2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 9h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    My Orders
                </a>
            </nav>
        </aside>

        <main class="main-content h-screen overflow-y-auto">
            <header class="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-gray-200">
                <div class="px-4 sm:px-6 lg:px-8">
                    <div class="flex h-16 items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <button id="hamburger-btn" class="text-gray-500 md:hidden"> <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg> </button>
                            <div>
                                <h1 class="text-xl font-semibold text-gray-900">Campus Marketplace</h1>
                                <p class="text-sm text-gray-500">Buy and sell items within the campus community</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="relative cart-btn-wrapper">
                                <button id="cart-btn" title="View Cart" class="relative rounded-full p-1.5 text-gray-500 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                     <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                    <span id="cart-badge" class="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-indigo-600 text-xs font-medium text-white transform scale-0 cart-badge">0</span>
                                </button>
                            </div>
                            <div class="relative">
                                <button id="user-profile" class="flex items-center rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                    <span class="sr-only">Open user menu</span>
                                    <div id="header-user-avatar" class="flex h-9 w-9 items-center justify-center rounded-full bg-indigo-600 text-sm font-medium text-white overflow-hidden">S</div>
                                </button>
                                <div id="profile-dropdown" class="absolute right-0 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10">
                                    <div class="py-1">
                                        <div class="border-b border-gray-200 px-4 py-3">
                                            <p id="profile-dropdown-name" class="text-sm font-medium text-gray-900 truncate">Student Name</p>
                                            <p id="profile-dropdown-email" class="text-sm text-gray-500 truncate">student@example.com</p>
                                        </div>
                                        <div class="py-1"><a href="profile.html" class="flex items-center gap-2 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100"> <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg> View Profile </a></div>
                                        <div class="border-t border-gray-200 py-1"><button id="logout-btn" class="flex items-center gap-2 text-gray-700 block w-full px-4 py-2 text-left text-sm hover:bg-gray-100"> <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg> Logout </button></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="p-4 sm:p-6 lg:p-8">
                <div class="mb-6">
                     <div class="relative flex-grow max-w-lg mx-auto">
                         <span class="absolute inset-y-0 left-0 flex items-center pl-3"> <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg> </span>
                        <input type="search" id="item-search" class="w-full rounded-md border border-gray-300 py-2 pl-10 pr-4 text-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="Search items...">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="marketplace-list">
                    <p class="text-center text-gray-500 py-10 col-span-full">Loading items...</p>
                    </div>
            </div>
        </main>
    </div>

    <div id="cart-modal-overlay" class="fixed inset-0 z-40 bg-gray-900 bg-opacity-50 invisible-overlay cart-modal-overlay">
        <div id="cart-modal" class="fixed top-0 right-0 bottom-0 z-50 flex w-full max-w-md translate-x-full flex-col bg-white shadow-xl transition-transform duration-300 ease-in-out">
            <div class="flex items-center justify-between border-b border-gray-200 p-4 sm:p-6">
                <h2 class="text-lg font-medium text-gray-900">Shopping Cart</h2>
                <div class="flex items-center space-x-2">
                    <label for="select-all-cart" class="text-sm text-gray-500">Select All</label>
                    <input type="checkbox" id="select-all-cart" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                </div>
                <button id="cart-close-btn" type="button" class="-m-2 p-2 text-gray-400 hover:text-gray-500"> <span class="sr-only">Close panel</span> <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button>
            </div>
            <div id="cart-body" class="flex-1 overflow-y-auto p-4 sm:p-6">
                <p class="cart-empty-msg text-center text-gray-500 py-10">Your cart is empty.</p>
                </div>
            <div id="cart-footer" class="border-t border-gray-200 bg-gray-50 p-4 sm:p-6 hidden">
                <div class="flex justify-between text-base font-medium text-gray-900">
                    <p>Selected Items Subtotal</p>
                    <p id="cart-subtotal-price">$0.00</p>
                </div>
                <p class="mt-1 text-sm text-gray-500">Items available for pickup.</p>
                <div class="mt-6">
                    <button id="checkout-btn" class="w-full flex items-center justify-center rounded-md border border-transparent bg-indigo-600 px-6 py-3 text-base font-medium text-white shadow-sm hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Checkout Selected
                    </button>
                </div>
                <div class="mt-4 flex justify-center text-center text-sm text-gray-500">
                    <p>or <button type="button" id="continue-shopping-btn" class="font-medium text-indigo-600 hover:text-indigo-500">Continue Shopping<span aria-hidden="true"> &rarr;</span></button></p>
                </div>
            </div>
        </div>
    </div>

    <div id="checkout-modal-overlay" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 invisible-overlay checkout-modal-overlay">
         <div id="checkout-modal" class="fixed inset-0 flex items-center justify-center p-4 transform scale-95 opacity-0 checkout-modal">
             <div class="relative w-full max-w-md overflow-hidden rounded-lg bg-white shadow-xl" onclick="event.stopPropagation()">
                 <div class="flex items-center justify-between border-b border-gray-200 p-4 sm:p-5">
                     <h2 class="text-lg font-medium text-gray-900">Confirm Purchase</h2>
                     <button id="checkout-close-btn" type="button" class="-m-2 p-2 text-gray-400 hover:text-gray-500"> <span class="sr-only">Close</span> <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button>
                 </div>
                 <div class="p-4 sm:p-6 space-y-4">
                     <div>
                         <p class="text-sm text-gray-600">You are about to purchase the selected items.</p>
                         <p class="mt-1 text-lg font-semibold text-gray-900">Total: <span id="checkout-total-price">$0.00</span></p>
                     </div>
                     <fieldset>
                         <legend class="text-base font-medium text-gray-900">Select Payment Method</legend>
                         <div class="mt-2 space-y-2">
                             <div class="flex items-center"> <input id="payment-gcash" name="payment-method" type="radio" value="gcash" checked class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"> <label for="payment-gcash" class="ml-3 block text-sm font-medium text-gray-700">GCash</label> </div>
                             <div class="flex items-center"> <input id="payment-cod" name="payment-method" type="radio" value="cod" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500"> <label for="payment-cod" class="ml-3 block text-sm font-medium text-gray-700">Cash on Delivery/Pickup</label> </div>
                             <div class="flex items-center"> <input id="payment-card" name="payment-method" type="radio" value="card" class="h-4 w-4 border-gray-300 text-indigo-600 focus:ring-indigo-500" disabled> <label for="payment-card" class="ml-3 block text-sm font-medium text-gray-500 cursor-not-allowed">Card Payment (Unavailable)</label> </div>
                         </div>
                     </fieldset>
                 </div>
                 <div class="border-t border-gray-200 bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-3">
                     <button id="confirm-purchase-btn" type="button" class="inline-flex w-full justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700 sm:w-auto sm:text-sm"> Confirm Purchase </button>
                     <button id="cancel-purchase-btn" type="button" class="mt-3 inline-flex w-full justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 sm:mt-0 sm:w-auto sm:text-sm"> Cancel </button>
                 </div>
             </div>
        </div>
    </div>

    <div id="toast-notification" class="fixed bottom-5 left-1/2 z-[60] -translate-x-1/2 transform rounded-md px-4 py-3 text-sm font-medium text-white shadow-lg opacity-0 transition-opacity translate-y-10 toast-notification hidden">
        <span id="toast-icon" class="mr-2"></span>
        <span id="toast-message"></span>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="../js/config/firebase.js"></script>
    <script>
        // --- Helper Functions ---
        let toastTimeout;
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.getElementById('toast-notification');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-message');
            if (!toast || !icon || !msg) { console.error("Toast elements not found!"); return; }
            msg.textContent = message;
            toast.className = 'fixed bottom-5 left-1/2 z-[60] -translate-x-1/2 transform rounded-md px-4 py-3 text-sm font-medium text-white shadow-lg transition-all duration-300 ease-in-out toast-notification';
            if (type === 'success') { toast.classList.add('bg-green-600'); icon.textContent = '✅'; }
            else if (type === 'error') { toast.classList.add('bg-red-600'); icon.textContent = '❌'; }
            else { toast.classList.add('bg-blue-600'); icon.textContent = 'ℹ️'; }
            toast.classList.remove('opacity-0', 'translate-y-10', 'hidden');
            toast.classList.add('opacity-100', 'translate-y-0');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                 toast.classList.remove('opacity-100', 'translate-y-0');
                 toast.classList.add('opacity-0', 'translate-y-10');
                 setTimeout(() => toast.classList.add('hidden'), 400);
            }, duration);
        }
        const formatCurrency = (num) => {
            if (typeof num !== 'number' || isNaN(num)) return '$0.00';
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
        };

        // --- Global Scope Modal Functions ---
        const checkoutOverlay = document.getElementById('checkout-modal-overlay');
        const checkoutModal = document.getElementById('checkout-modal');
        const confirmPurchaseBtn = document.getElementById('confirm-purchase-btn');
        const checkoutTotalPriceEl = document.getElementById('checkout-total-price');

        const openCheckoutModal = (selectedItems, totalPrice) => {
            console.log("Attempting to open checkout modal with items:", selectedItems, "Total:", totalPrice);
            if (!checkoutOverlay || !checkoutModal || !confirmPurchaseBtn || !checkoutTotalPriceEl) {
                 console.error("Checkout modal elements not found in openCheckoutModal!");
                 showToast("Checkout UI error. Please refresh.", "error");
                 return;
            }
            if (!Array.isArray(selectedItems) || selectedItems.length === 0) {
                showToast("Cannot checkout: No items selected or item data missing.", "info");
                return;
            }
            confirmPurchaseBtn.setAttribute('data-selected-items', JSON.stringify(selectedItems));
            confirmPurchaseBtn.setAttribute('data-total-price', totalPrice);
            checkoutTotalPriceEl.textContent = formatCurrency(totalPrice);

            checkoutOverlay.classList.remove('invisible-overlay', 'hidden');
            checkoutOverlay.classList.add('visible-overlay');
            checkoutModal.classList.remove('scale-95', 'opacity-0', 'hidden');
            void checkoutModal.offsetWidth;
            checkoutModal.classList.add('scale-100', 'opacity-100');
            console.log("Checkout modal should be open.");
        };

        const closeCheckoutModal = () => {
             if (!checkoutOverlay || !checkoutModal || !confirmPurchaseBtn) { console.warn("Checkout modal elements not found in closeCheckoutModal."); return; }
             checkoutOverlay.classList.remove('visible-overlay');
             checkoutOverlay.classList.add('invisible-overlay');
             checkoutModal.classList.remove('scale-100', 'opacity-100');
             checkoutModal.classList.add('scale-95', 'opacity-0');
             setTimeout(() => {
                 checkoutOverlay.classList.add('hidden');
                 checkoutModal.classList.add('hidden');
             }, 300);
             setTimeout(() => {
                 confirmPurchaseBtn.removeAttribute('data-selected-items');
                 confirmPurchaseBtn.removeAttribute('data-total-price');
             }, 300);
             console.log("Checkout modal closed.");
        };


        // --- Main Marketplace Logic ---
        document.addEventListener('DOMContentLoaded', function() {
            // Basic UI Setup
            const sidebar = document.getElementById('student-sidebar');
            const hamburgerBtn = document.getElementById('hamburger-btn');
            hamburgerBtn.addEventListener('click', () => {
                 sidebar.classList.toggle('is-open');
                 sidebar.classList.toggle('-translate-x-full');
            });

            const userProfile = document.getElementById('user-profile');
            const dropdown = document.getElementById('profile-dropdown');
            userProfile.addEventListener('click', (event) => {
                event.stopPropagation();
                dropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', (event) => {
                 if (dropdown && !userProfile.contains(event.target) && !dropdown.contains(event.target)) {
                     dropdown.classList.add('hidden');
                 }
            });

            const loadingOverlay = document.getElementById('loading');
            loadingOverlay.style.display = 'flex';
            document.body.classList.add('loading-active');

            let currentUser = null;

            // --- Firebase Auth Listener ---
            firebase.auth().onAuthStateChanged(async (user) => {
                if (!user) { window.location.href = '../login.html'; return; }
                currentUser = user;
                let userRole = 'student';
                try {
                    const roleSnapshot = await firebase.database().ref(`users/${user.uid}/role`).once('value');
                    userRole = roleSnapshot.val() || 'student';
                } catch(error){ console.error("Could not fetch user role:", error); }
                if (userRole === 'admin') { window.location.href = '../admin/dashboard.html'; return; }

                const userName = user.displayName || user.email.split('@')[0];
                document.getElementById('profile-dropdown-name').textContent = userName;
                document.getElementById('profile-dropdown-email').textContent = user.email;
                const headerAvatar = document.getElementById('header-user-avatar');
                 if (user.photoURL) { headerAvatar.innerHTML = `<img src="${user.photoURL}" alt="Profile" class="h-full w-full object-cover">`; }
                 else { headerAvatar.textContent = userName.charAt(0).toUpperCase(); }

                initMarketplace(user);
                initCart(user); // initCart sets up its own listeners including checkout

                loadingOverlay.style.display = 'none';
                document.body.classList.remove('loading-active');
            });

            // Logout Button
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    loadingOverlay.style.display = 'flex';
                    document.body.classList.add('loading-active');
                    try { await firebase.auth().signOut(); window.location.href = '../login.html'; }
                    catch (error) { console.error("Logout failed: ", error); loadingOverlay.style.display = 'none'; document.body.classList.remove('loading-active'); }
                });
            }

            // --- Cart Modal UI ---
            const cartOverlay = document.getElementById('cart-modal-overlay');
            const cartModal = document.getElementById('cart-modal');
            const cartBtn = document.getElementById('cart-btn');
            const cartCloseBtn = document.getElementById('cart-close-btn');
            const continueShoppingBtn = document.getElementById('continue-shopping-btn');
            const openCart = () => {
                cartOverlay.classList.remove('invisible-overlay', 'hidden'); // Use visibility class
                cartOverlay.classList.add('visible-overlay');
                cartModal.classList.remove('translate-x-full');
            };
            const closeCart = () => {
                 cartOverlay.classList.remove('visible-overlay');
                 cartOverlay.classList.add('invisible-overlay');
                 cartModal.classList.add('translate-x-full');
                 // Optionally add hidden after transition
                 setTimeout(() => cartOverlay.classList.add('hidden'), 300);
            };
            if(cartBtn) cartBtn.addEventListener('click', openCart); // Add null check
            if(cartCloseBtn) cartCloseBtn.addEventListener('click', closeCart);
            if(continueShoppingBtn) continueShoppingBtn.addEventListener('click', closeCart);
            if(cartOverlay) cartOverlay.addEventListener('click', (e) => { if (e.target === cartOverlay) closeCart(); });

            // --- Checkout Modal UI (Listeners for close/cancel/confirm) ---
            const checkoutCloseBtn = document.getElementById('checkout-close-btn');
            const cancelPurchaseBtn = document.getElementById('cancel-purchase-btn');
            const confirmBtnGlobal = document.getElementById('confirm-purchase-btn'); // Use global reference
            if (checkoutCloseBtn) checkoutCloseBtn.addEventListener('click', closeCheckoutModal);
            if (cancelPurchaseBtn) cancelPurchaseBtn.addEventListener('click', closeCheckoutModal);
            if (checkoutOverlay) checkoutOverlay.addEventListener('click', (e) => { if (e.target === checkoutOverlay) closeCheckoutModal(); });
            if (confirmBtnGlobal) confirmBtnGlobal.addEventListener('click', handleConfirmPurchase); // Add listener here

        }); // END DOMContentLoaded

        // --- Marketplace Rendering ---
         let allMarketplaceItems = {};
         function initMarketplace(user) {
            const listElement = document.getElementById('marketplace-list');
            const searchInput = document.getElementById('item-search');
            if (!listElement || !searchInput) { console.error("Marketplace list or search not found!"); return; }
            const marketplaceRef = firebase.database().ref('marketplace');

            const renderMarketplace = (filterText = '') => {
                 listElement.innerHTML = ''; let hasItems = false;
                 // console.log("Rendering marketplace. Filter:", filterText); // Optional

                 const filteredKeys = Object.keys(allMarketplaceItems).filter(key => {
                     const item = allMarketplaceItems[key];
                     if (!item || !item.name || typeof item.price !== 'number' || typeof item.quantity !== 'number') return false;
                     const isOwnItem = item.sellerId === user.uid;
                     const isInStock = item.quantity > 0;
                     const nameMatch = !filterText || item.name.toLowerCase().includes(filterText.toLowerCase());
                     return !isOwnItem && isInStock && nameMatch;
                 });
                 filteredKeys.sort((a, b) => (allMarketplaceItems[b].createdAt || 0) - (allMarketplaceItems[a].createdAt || 0));

                 filteredKeys.forEach(key => {
                     hasItems = true; const item = allMarketplaceItems[key];
                     const itemCard = document.createElement('div');
                     itemCard.className = 'flex flex-col overflow-hidden rounded-lg bg-white shadow border border-gray-200 transition-shadow hover:shadow-md';
                     const imageUrl = item.imageUrl || `https://placehold.co/400x300/e5e7eb/6b7280?text=No+Image`;
                     itemCard.innerHTML = `
                        <div class="relative h-48 w-full bg-gray-200"> <img src="${imageUrl}" alt="${item.name || 'Item Image'}" class="h-full w-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/400x300/e5e7eb/6b7280?text=Invalid+URL';"> <span class="absolute top-2 right-2 inline-flex items-center rounded-full bg-indigo-600 px-3 py-0.5 text-sm font-medium text-white"> ${formatCurrency(item.price)} </span> </div>
                        <div class="flex flex-1 flex-col justify-between p-4">
                            <div> <h3 class="text-lg font-semibold text-gray-900">${item.name || 'Untitled Item'}</h3> <p class="mt-1 text-sm text-gray-500">Qty: ${item.quantity || 0} | Seller: ${item.sellerName || 'N/A'}</p> <p class="mt-2 text-sm text-gray-600 line-clamp-2"> ${item.description || 'No description available.'} </p> </div>
                            <div class="mt-4 flex gap-2">
                                <button class="buy-now-btn flex-1 inline-flex items-center justify-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed" data-item-id="${key}" ${item.quantity <= 0 ? 'disabled' : ''}> Buy Now </button>
                                <button class="add-to-cart-btn flex-1 inline-flex items-center justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:bg-gray-400 disabled:hover:bg-gray-400" data-item-id="${key}" ${item.quantity <= 0 ? 'disabled' : ''}> ${item.quantity <= 0 ? 'Out of Stock' : 'Add to Cart'} </button>
                            </div>
                        </div>`;
                     listElement.appendChild(itemCard);
                 });
                 if (!hasItems) { listElement.innerHTML = `<p class="text-center text-gray-500 py-10 col-span-full">${filterText ? 'No items match your search.' : 'No items available for purchase currently.'}</p>`; }
            };

            marketplaceRef.on('value', (snapshot) => {
                // console.log("Marketplace data received:", snapshot.val()); // Debug
                allMarketplaceItems = snapshot.val() || {};
                renderMarketplace(searchInput.value);
            }, (error) => { console.error("Firebase marketplace read error:", error); /* error handling */ });
            searchInput.addEventListener('input', (e) => renderMarketplace(e.target.value));

            if (listElement) {
                listElement.addEventListener('click', (e) => {
                    const buyBtn = e.target.closest('.buy-now-btn');
                    const addBtn = e.target.closest('.add-to-cart-btn');
                    const user = firebase.auth().currentUser;
                    if (buyBtn && !buyBtn.disabled && user) {
                        console.log("Buy Now clicked for item:", buyBtn.dataset.itemId); // DEBUG
                        const itemId = buyBtn.dataset.itemId;
                        handleBuyNow(user, itemId); // Call global function
                    } else if (addBtn && !addBtn.disabled && user) {
                        // console.log("Add to Cart clicked for item:", addBtn.dataset.itemId); // DEBUG
                        const itemId = addBtn.dataset.itemId;
                        const item = allMarketplaceItems[itemId];
                        if (item) { addToCart(user.uid, itemId, item); }
                        else { console.error("Item data not found for add to cart:", itemId); }
                    }
                });
            } else { console.error("Marketplace list element not found!"); }
        }

        // --- Buy Now Logic ---
        function handleBuyNow(user, itemId) {
             console.log("handleBuyNow called for item:", itemId); // DEBUG
             const item = allMarketplaceItems[itemId];
             if (!item || item.quantity <= 0) { showToast("Item not available.", "error"); return; }
             const price = typeof item.price === 'number' ? item.price : parseFloat(item.price || 0);
             if (isNaN(price)) { showToast("Item has an invalid price.", "error"); return; }
             const singleItem = { ...item, itemId: itemId, keyInCart: itemId, price: price };
             openCheckoutModal([singleItem], price); // Call global function
        }

        // --- Cart Logic ---
        function addToCart(userId, itemId, item) {
             const cartRef = firebase.database().ref(`carts/${userId}/${itemId}`);
             let wasAlreadyInCart = false;
             cartRef.once('value').then(snapshot => {
                wasAlreadyInCart = snapshot.exists();
                if (wasAlreadyInCart) { showToast('Item is already in your cart.', 'info'); return Promise.reject('Item already in cart'); }
                else { return firebase.database().ref(`marketplace/${itemId}`).once('value'); }
            }).then(itemSnapshot => {
                if (!itemSnapshot) return; // Should not happen if previous step worked
                const currentItemData = itemSnapshot.val();
                if (currentItemData && currentItemData.quantity > 0) {
                    const price = typeof item.price === 'number' ? item.price : parseFloat(item.price || 0);
                    if (isNaN(price)) throw new Error("Item has invalid price.");
                    const itemToAdd = { name: item.name || 'Untitled Item', price: price, imageUrl: item.imageUrl || null, itemId: itemId, sellerId: item.sellerId, sellerName: item.sellerName };
                    return cartRef.set(itemToAdd);
                } else { throw new Error(`${item.name || 'Item'} is now out of stock.`); }
            }).then(() => { if (!wasAlreadyInCart) { showToast(`${item.name || 'Item'} added to cart!`, 'success'); }
            }).catch(err => {
                if (err !== 'Item already in cart') { console.error("Add to cart error:", err); showToast(err.message || 'Error adding item.', 'error'); }
                if (err instanceof Error && err.message.includes('out of stock')) {
                     const searchInput = document.getElementById('item-search');
                     if (searchInput) { const val = searchInput.value; searchInput.dispatchEvent(new Event('input', { bubbles: true })); searchInput.value = val; } // Trigger render
                }
            });
        }

        function initCart(user) {
            const userId = user.uid;
            const cartRef = firebase.database().ref(`carts/${userId}`);
            const cartBody = document.getElementById('cart-body');
            const cartBadge = document.getElementById('cart-badge');
            const cartFooter = document.getElementById('cart-footer');
            const subtotalEl = document.getElementById('cart-subtotal-price');
            const checkoutBtn = document.getElementById('checkout-btn');
            const selectAllCheckbox = document.getElementById('select-all-cart');
            if (!cartBody || !cartBadge || !cartFooter || !subtotalEl || !checkoutBtn || !selectAllCheckbox) { console.error("Cart UI elements missing!"); return; }

            cartRef.on('value', (snapshot) => {
                // console.log("Cart data received:", snapshot.val()); // Debug
                const cartItems = snapshot.val() || {};
                renderCartItems(userId, cartItems);
                updateCartSelectionState(cartItems);
            }, (error) => { console.error("Firebase cart read error:", error); /* error handling */ });

            cartBody.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.cart-remove-btn');
                const checkbox = e.target.closest('.cart-item-checkbox');
                if (removeBtn) {
                     const itemKey = removeBtn.dataset.itemKey;
                     firebase.database().ref(`carts/${userId}/${itemKey}`).remove()
                         .then(() => showToast('Item removed.', 'info'))
                         .catch(err => showToast(`Error: ${err.message}`, 'error'));
                 }
                else if (checkbox) {
                     const cartItems = JSON.parse(cartBody.dataset.cartItems || '{}');
                     updateCartSelectionState(cartItems);
                 }
            });
            selectAllCheckbox.addEventListener('change', (e) => {
                 const isChecked = e.target.checked;
                 cartBody.querySelectorAll('.cart-item-checkbox').forEach(checkbox => checkbox.checked = isChecked);
                 const cartItems = JSON.parse(cartBody.dataset.cartItems || '{}');
                 updateCartSelectionState(cartItems);
            });

            // Ensure checkout button exists before adding listener
            if (checkoutBtn) {
                checkoutBtn.addEventListener('click', () => {
                     console.log("Checkout button clicked. Disabled:", checkoutBtn.disabled); // DEBUG
                     if (checkoutBtn.disabled) return;
                     const selectedItems = []; let totalPrice = 0;
                     const currentCartItems = JSON.parse(cartBody.dataset.cartItems || '{}');
                     cartBody.querySelectorAll('.cart-item-checkbox:checked').forEach(checkbox => {
                         const itemKey = checkbox.dataset.itemKey; const itemData = currentCartItems[itemKey];
                         const price = itemData ? (typeof itemData.price === 'number' ? itemData.price : parseFloat(itemData.price || 0)) : NaN;
                         if (itemData && !isNaN(price)) { selectedItems.push({ ...itemData, keyInCart: itemKey, price: price }); totalPrice += price; }
                         else { console.warn("Skipping invalid item in checkout:", itemKey, itemData); }
                     });
                     console.log("Selected items for checkout:", selectedItems, "Total:", totalPrice); // DEBUG
                     openCheckoutModal(selectedItems, totalPrice); // Call global function
                });
            } else { console.error("Checkout button not found!"); }
        }

        function renderCartItems(userId, cartItems) {
            const cartBody = document.getElementById('cart-body');
            const itemKeys = Object.keys(cartItems);
            cartBody.innerHTML = '';
             try { cartBody.dataset.cartItems = JSON.stringify(cartItems); }
             catch (e) { console.error("Failed to stringify cart items:", e); cartBody.dataset.cartItems = '{}'; }

            if (itemKeys.length === 0) {
                 cartBody.innerHTML = '<p class="cart-empty-msg text-center text-gray-500 py-10">Your cart is empty.</p>';
            } else {
                 itemKeys.forEach(key => {
                    const item = cartItems[key];
                     if (!item || typeof item.price !== 'number') { console.warn("Skipping invalid cart item:", key, item); return; }
                    const cartItemEl = document.createElement('div');
                    cartItemEl.className = 'cart-item flex items-start gap-3 py-4 border-b border-gray-200 last:border-b-0';
                    const imgUrl = item.imageUrl || 'https://placehold.co/64x64/e5e7eb/6b7280?text=N/A';
                    cartItemEl.innerHTML = `
                        <input type="checkbox" class="cart-item-checkbox h-4 w-4 mt-1 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" data-item-key="${key}" data-item-price="${item.price}">
                        <img src="${imgUrl}" alt="${item.name || 'Item'}" class="h-16 w-16 flex-shrink-0 rounded-md border border-gray-200 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/64x64/e5e7eb/6b7280?text=Error';">
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between text-sm font-medium text-gray-900">
                                <h3 class="truncate pr-2">${item.name || 'Untitled Item'}</h3>
                                <p class="ml-4 flex-shrink-0">${formatCurrency(item.price)}</p>
                            </div>
                             <p class="mt-0.5 text-xs text-gray-500">Seller: ${item.sellerName || 'N/A'}</p>
                        </div>
                        <button class="cart-remove-btn font-medium text-indigo-600 hover:text-indigo-500 text-xs ml-2 flex-shrink-0" data-item-key="${key}" title="Remove">Remove</button>
                    `;
                    cartBody.appendChild(cartItemEl);
                 });
            }
        }

        function updateCartSelectionState(cartItems) {
             const cartBody = document.getElementById('cart-body');
             const selectAllCheckbox = document.getElementById('select-all-cart');
             const subtotalEl = document.getElementById('cart-subtotal-price');
             const checkoutBtn = document.getElementById('checkout-btn');
             const cartFooter = document.getElementById('cart-footer');
             const itemCheckboxes = cartBody.querySelectorAll('.cart-item-checkbox');
             const cartBadge = document.getElementById('cart-badge');
             if (!checkoutBtn) return;

             let calculatedSubtotal = 0; let allSelectedInUI = true; let selectedCount = 0;
             const totalItemsInCart = Object.keys(cartItems).length;

             itemCheckboxes.forEach(checkbox => {
                 if (checkbox.checked) {
                     const price = parseFloat(checkbox.dataset.itemPrice);
                     if (!isNaN(price)) { calculatedSubtotal += price; selectedCount++; }
                     else { console.warn("Invalid price on checkbox:", checkbox.dataset); }
                 } else { allSelectedInUI = false; }
             });

             if (subtotalEl) subtotalEl.textContent = formatCurrency(calculatedSubtotal);

             if (selectAllCheckbox) {
                 if (itemCheckboxes.length > 0) { selectAllCheckbox.checked = allSelectedInUI; selectAllCheckbox.indeterminate = !allSelectedInUI && selectedCount > 0; }
                 else { selectAllCheckbox.checked = false; selectAllCheckbox.indeterminate = false; }
             }

             checkoutBtn.disabled = selectedCount === 0;
             // console.log("Updating cart state. Selected:", selectedCount, "Btn Disabled:", checkoutBtn.disabled); // Debug

             if(cartFooter) cartFooter.classList.toggle('hidden', totalItemsInCart === 0);

             if(cartBadge){
                 cartBadge.textContent = totalItemsInCart;
                 cartBadge.classList.toggle('scale-100', totalItemsInCart > 0);
                 cartBadge.classList.toggle('scale-0', totalItemsInCart === 0);
             }
        }

        // --- Checkout Logic ---
         // --- Checkout Logic ---
         async function handleConfirmPurchase() {
            const confirmBtn = document.getElementById('confirm-purchase-btn');
            if (!confirmBtn) { console.error("Confirm purchase button not found!"); return; }
            let selectedItems = []; try { selectedItems = JSON.parse(confirmBtn.getAttribute('data-selected-items') || '[]'); } catch(e) { console.error("Error parsing selected items:", e); showToast("Checkout error.", "error"); return;}
            const totalPrice = parseFloat(confirmBtn.getAttribute('data-total-price') || 0);
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value;
            const user = firebase.auth().currentUser;
            const loadingOverlay = document.getElementById('loading');

            if (!user || !Array.isArray(selectedItems) || selectedItems.length === 0 || !paymentMethod || isNaN(totalPrice)) {
                 showToast("Missing or invalid info for checkout.", "error"); console.error("Checkout validation failed:", { user, selectedItems, paymentMethod, totalPrice }); return;
            }

            confirmBtn.disabled = true; confirmBtn.textContent = 'Processing...';
            loadingOverlay.style.display = 'flex'; document.body.classList.add('loading-active');

            try {
                if (paymentMethod === 'gcash') {
                    // ... (GCash logic is unchanged)
                    showToast("Redirecting to GCash...", "info", 5000);
                    loadingOverlay.style.display = 'none'; document.body.classList.remove('loading-active'); // Hide overlay BEFORE redirect
                    setTimeout(() => { window.location.href = 'https://pay.gcash.com/placeholder_for_campuscore'; }, 500);

                } else if (paymentMethod === 'cod' || paymentMethod === 'card') {
                    // Pre-check stock (This is still good practice)
                    const itemChecks = selectedItems.map(item => firebase.database().ref(`marketplace/${item.itemId}/quantity`).once('value'));
                    const quantitySnapshots = await Promise.all(itemChecks);
                    for(let i = 0; i < quantitySnapshots.length; i++) {
                         const quantity = quantitySnapshots[i].val();
                         if (quantity === null || quantity <= 0) { throw new Error(`"${selectedItems[i].name}" is no longer in stock.`); }
                    }

                    // *** THIS FUNCTION IS NOW MODIFIED ***
                    const orderId = await processOrder(user, selectedItems, totalPrice, paymentMethod);

                    // Redirect to confirmation page on success
                    window.location.href = `order-confirmation.html?orderId=${orderId}&paymentMethod=${paymentMethod}`;

                } else { throw new Error("Invalid payment method selected."); }

            } catch (error) {
                console.error("Purchase confirmation failed: ", error);
                showToast(error.message || 'Checkout failed. Please try again.', 'error');
                confirmBtn.disabled = false; confirmBtn.textContent = 'Confirm Purchase';
                loadingOverlay.style.display = 'none'; document.body.classList.remove('loading-active');
            }
         }

        // --- MODIFIED processOrder FUNCTION ---
        async function processOrder(user, selectedItems, totalPrice, paymentMethod) {
            const userId = user.uid;
            const buyerName = user.displayName || user.email.split('@')[0];
            const updates = {};
            const orderId = firebase.database().ref().child('orders').push().key;

            for (const item of selectedItems) {
                if (!item.itemId || !item.keyInCart || typeof item.price !== 'number') { throw new Error(`Invalid data for item "${item.name || 'Unknown Item'}".`); }
                
                // REMOVED: This line caused the permission error
                // updates[`marketplace/${item.itemId}/quantity`] = firebase.database.ServerValue.increment(-1); 
                
                // Keep this line
                updates[`carts/${userId}/${item.keyInCart}`] = null;
            }

            const orderData = {
                orderId: orderId, userId: userId, buyerName: buyerName,
                items: selectedItems.map(({ keyInCart, ...rest }) => rest), // Remove temp cart key
                totalPrice: totalPrice, paymentMethod: paymentMethod,
                status: 'Pending Pickup', createdAt: firebase.database.ServerValue.TIMESTAMP
            };
            updates[`orders/${orderId}`] = orderData;

            console.log("Applying Firebase updates:", updates); // Debug
            await firebase.database().ref().update(updates);
            console.log("Firebase update successful for order:", orderId); // Debug
            return orderId;
        }

    </script>
</body>
</html>