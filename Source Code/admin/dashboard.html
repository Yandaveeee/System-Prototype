<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CampusCore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="../assets/icons/favicon.ico"> <style>
        /* Apply Inter font */
        body { font-family: 'Inter', sans-serif; }
        
        /* Basic styles from previous iterations */
        :root { --primary-color: #4f46e5; --primary-hover: #4338ca; --text-primary: #111827; --text-secondary: #6b7280; --bg-body: #f9fafb; --bg-sidebar: #ffffff; --bg-content: #ffffff; --border-color: #e5e7eb; --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05); --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --radius: 0.5rem; /* 8px */ }
        
        /* Sidebar basic styles */
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar.is-open { transform: translateX(0); box-shadow: var(--shadow-md); }
        
        /* Simple spinner */
        .loading-spinner { border: 4px solid #f3f4f6; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.9); display: none; /* Changed from flex */ align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.3s; }
        .hidden { display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Notification Badge - Small red dot */
        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            background-color: #ef4444; /* Red color */
            border-radius: 50%;
            border: 2px solid var(--bg-content); /* Match dropdown background */
            transform: scale(0);
            transition: transform 0.2s ease-out;
        }
        .notification-badge.visible { transform: scale(1); }
        
        /* Ensure dropdowns appear above content */
        .profile-dropdown, .notification-dropdown { z-index: 50; }

    </style>
</head>
<body class="bg-gray-50">
    <div id="loading" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-[260px_1fr] h-screen">
        <aside id="admin-sidebar" class="bg-white border-r border-gray-200 flex flex-col fixed inset-y-0 left-0 w-64 z-30 transform -translate-x-full md:translate-x-0 md:static">
            <div class="px-6 py-4 border-b border-gray-200">
                <a href="dashboard.html" class="text-2xl font-bold text-indigo-600">CampusCore</a>
            </div>
            <nav class="flex-grow p-4 space-y-1">
                <a href="dashboard.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md bg-indigo-600 text-white">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    Dashboard
                </a>
                <a href="manage-announcements.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.144-6.126A.75.75 0 015.5 12.632v-1.264a.75.75 0 01.621-.74l6.164-1.898a.75.75 0 01.88 0l6.164 1.898a.75.75 0 01.621.74v1.264a.75.75 0 01-.121.402l-2.144 6.126A1.76 1.76 0 0113 19.24V5.882" /></svg>
                    Announcements
                </a>
                <a href="manage-events.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900">
                     <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    Events
                </a>
                <a href="manage-resources.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                    Resources
                </a>
                 <a href="manage-lost-found.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 10.5a.5.5 0 01.5-.5h3a.5.5 0 010 1h-3a.5.5 0 01-.5-.5z" /></svg>
                    Lost & Found
                </a>
                 <a href="manage-marketplace.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    Marketplace
                </a>
                <a href="manage-orders.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2h2a2 2 0 002 2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 9h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                    Manage Orders
                </a>
                <a href="manage-users.html" class="flex items-center gap-3 px-4 py-2.5 text-sm font-medium rounded-md text-gray-500 hover:bg-gray-100 hover:text-gray-900">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    Manage Users
                </a>
            </nav>
        </aside>

        <main class="main-content h-screen overflow-y-auto">
            <header class="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-gray-200">
                <div class="px-4 sm:px-6 lg:px-8">
                    <div class="flex h-16 items-center justify-between gap-4">
                        <div class="flex items-center gap-4">
                            <button id="hamburger-btn" class="text-gray-500 md:hidden">
                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                            </button>
                            <h1 class="text-xl font-semibold text-gray-900">Dashboard</h1>
                        </div>

                        <div class="flex-1 max-w-lg hidden md:block">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                    <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
                                </span>
                                <input type="search" class="w-full rounded-md border border-gray-300 bg-gray-50 py-2 pl-10 pr-4 text-sm focus:border-indigo-500 focus:bg-white focus:outline-none focus:ring-1 focus:ring-indigo-500" placeholder="Search...">
                            </div>
                        </div>

                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <button id="notification-bell" class="relative rounded-full p-1.5 text-gray-500 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.017 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
                                    <span id="notification-badge" class="notification-badge"></span> </button>
                                <div id="notification-dropdown" class="absolute right-0 mt-2 w-80 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical">
                                    <div class="py-1">
                                         <div class="px-4 py-2 text-sm font-semibold text-gray-900 border-b border-gray-200">New Orders</div>
                                         <ul id="notification-list" class="max-h-60 overflow-y-auto">
                                            <li class="notification-empty px-4 py-3 text-sm text-gray-500 text-center">No new orders.</li>
                                         </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="relative">
                                <button id="user-profile" class="flex items-center rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                    <span class="sr-only">Open user menu</span>
                                    <div id="header-user-avatar" class="flex h-9 w-9 items-center justify-center rounded-full bg-indigo-600 text-sm font-medium text-white overflow-hidden">
                                        A </div>
                                </button>
                                <div id="profile-dropdown" class="absolute right-0 mt-2 w-56 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none hidden" role="menu" aria-orientation="vertical">
                                    <div class="py-1" role="none">
                                        <div class="border-b border-gray-200 px-4 py-3">
                                            <p id="profile-name" class="text-sm font-medium text-gray-900 truncate" role="none">Admin Name</p>
                                            <p id="profile-email" class="text-sm text-gray-500 truncate" role="none">admin@example.com</p>
                                        </div>
                                        <div class="py-1" role="none">
                                            <a href="profile.html" class="flex items-center gap-2 text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem">
                                                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                                View Profile
                                            </a>
                                        </div>
                                         <div class="border-t border-gray-200 py-1" role="none">
                                             <button id="profile-menu-logout" class="flex items-center gap-2 text-gray-700 block w-full px-4 py-2 text-left text-sm hover:bg-gray-100" role="menuitem">
                                                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                                                Logout
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="p-4 sm:p-6 lg:p-8">
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-8">
                    
                    <a href="manage-users.html" class="block rounded-lg hover:shadow-lg transition-shadow">
                        <div class="overflow-hidden rounded-lg bg-white shadow border border-gray-200 h-full">
                            <div class="p-5 flex flex-col justify-between h-full">
                                <div> <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <div class="flex h-12 w-12 items-center justify-center rounded-full bg-indigo-100 text-indigo-600">
                                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                                            </div>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="truncate text-sm font-medium text-gray-500">Total Users</dt>
                                                <dd id="stat-total-users" class="text-3xl font-semibold text-gray-900">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 text-sm font-medium text-indigo-600 hover:text-indigo-500">
                                    View Users &rarr;
                                </div>
                            </div>
                        </div>
                    </a>

                    <a href="manage-orders.html" class="block rounded-lg hover:shadow-lg transition-shadow">
                         <div class="overflow-hidden rounded-lg bg-white shadow border border-gray-200 h-full">
                            <div class="p-5 flex flex-col justify-between h-full">
                                <div> <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <div class="flex h-12 w-12 items-center justify-center rounded-full bg-green-100 text-green-600">
                                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3-.895 3-2 1.343-2 3-2m0 8c1.11 0 2.08-.402 2.599-1M12 16v1m0-1v-8" /></svg>
                                            </div>
                                        </div>
                                        <div class="ml-5 flex-1">
                                            <dl>
                                                <dt class="truncate text-sm font-medium text-gray-500">Total Sales</dt>
                                                <dd id="stat-total-sales" class="text-2xl font-semibold text-gray-900">$0.00</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 text-sm font-medium text-green-600 hover:text-green-500">
                                    View Orders &rarr;
                                </div>
                            </div>
                        </div>
                    </a>

                    <a href="manage-events.html" class="block rounded-lg hover:shadow-lg transition-shadow">
                        <div class="overflow-hidden rounded-lg bg-white shadow border border-gray-200 h-full">
                            <div class="p-5 flex flex-col justify-between h-full">
                                <div> <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <div class="flex h-12 w-12 items-center justify-center rounded-full bg-yellow-100 text-yellow-600">
                                                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                            </div>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="truncate text-sm font-medium text-gray-500">Upcoming Events</dt>
                                                <dd id="stat-upcoming-events" class="text-3xl font-semibold text-gray-900">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 text-sm font-medium text-yellow-600 hover:text-yellow-500">
                                    View Events &rarr;
                                </div>
                            </div>
                        </div>
                    </a>

                    <a href="manage-marketplace.html" class="block rounded-lg hover:shadow-lg transition-shadow">
                         <div class="overflow-hidden rounded-lg bg-white shadow border border-gray-200 h-full">
                            <div class="p-5 flex flex-col justify-between h-full">
                                <div> <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <div class="flex h-12 w-12 items-center justify-center rounded-full bg-red-100 text-red-600">
                                                 <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                            </div>
                                        </div>
                                        <div class="ml-5 w-0 flex-1">
                                            <dl>
                                                <dt class="truncate text-sm font-medium text-gray-500">Active Items</dt>
                                                <dd id="stat-active-items" class="text-3xl font-semibold text-gray-900">0</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4 text-sm font-medium text-red-600 hover:text-red-500">
                                    View Marketplace &rarr;
                                </div>
                            </div>
                        </div>
                    </a>
                </div>

                <div class="rounded-lg bg-white shadow border border-gray-200 p-6">
                    <h2 class="text-xl font-semibold mb-2">Welcome, Admin!</h2>
                    <p class="text-gray-600">This is your central hub for managing CampusCore. Use the sidebar to navigate through different management sections.</p>
                </div>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <script src="../js/config/firebase.js"></script>
    <script>
        // --- Profile Logic ---
        function setupProfileDropdown(user) {
            const userProfileButton = document.getElementById('user-profile');
            const dropdown = document.getElementById('profile-dropdown');
            
            // Populate Dropdown Header
            document.getElementById('profile-name').textContent = user.displayName || 'Admin';
            document.getElementById('profile-email').textContent = user.email || 'No Email';
            updateAvatarDisplays(user.photoURL, user.displayName); // Update header avatar too

            userProfileButton.addEventListener('click', (event) => {
                event.stopPropagation();
                dropdown.classList.toggle('hidden');
                // MODIFIED: Close notification dropdown when opening profile
                document.getElementById('notification-dropdown')?.classList.add('hidden');
            });
            document.addEventListener('click', (event) => {
                // MODIFIED: Close notification dropdown as well
                const notificationDropdown = document.getElementById('notification-dropdown');
                const notificationBell = document.getElementById('notification-bell');
                
                if (dropdown && !userProfileButton.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.classList.add('hidden');
                }
                if (notificationDropdown && notificationBell && !notificationBell.contains(event.target) && !notificationDropdown.contains(event.target)) {
                    notificationDropdown.classList.add('hidden');
                }
            });
            document.getElementById('profile-menu-logout').addEventListener('click', () => {
                if (confirm('Are you sure you want to logout?')) {
                    firebase.auth().signOut().then(() => window.location.href = '../login.html');
                }
            });
        }

        // --- Avatar Logic ---
        function updateAvatarDisplays(imageUrl, displayName) {
            const avatar = document.getElementById('header-user-avatar'); // Only update header one
            const initial = (displayName || 'A').charAt(0).toUpperCase();
            
            if (imageUrl) {
                avatar.innerHTML = `<img src="${imageUrl}" alt="Profile" class="h-full w-full object-cover">`;
            } else {
                avatar.textContent = initial;
                 avatar.innerHTML = initial; // Ensure no lingering img tag
            }
        }
        
        // --- Notification Logic ---
        function initNotifications(user) {
            const bell = document.getElementById('notification-bell');
            const badge = document.getElementById('notification-badge');
            const dropdown = document.getElementById('notification-dropdown');
            const list = document.getElementById('notification-list');
            const emptyState = document.querySelector('.notification-empty');

            // Toggle dropdown
            bell.addEventListener('click', (event) => {
                event.stopPropagation();
                dropdown.classList.toggle('hidden');
                // MODIFIED: Close profile dropdown when opening notifications
                document.getElementById('profile-dropdown')?.classList.add('hidden');
            });
            // Global click listener in setupProfileDropdown handles closing

            // Firebase listener for new orders (status: Pending Pickup)
            const ordersRef = firebase.database().ref('orders');
            ordersRef.orderByChild('status').equalTo('Pending Pickup').on('value', (snapshot) => {
                const newOrders = snapshot.val();
                let count = 0;
                list.innerHTML = ''; // Clear previous items

                if (newOrders) {
                    const orderKeys = Object.keys(newOrders);
                    count = orderKeys.length;
                    
                    // Sort by newest first before displaying
                    orderKeys.sort((a, b) => newOrders[b].createdAt - newOrders[a].createdAt).forEach(key => {
                        const order = newOrders[key];
                        const item = document.createElement('li');
                        item.className = 'block px-4 py-3 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0';
                        item.innerHTML = `
                            <p class="font-medium text-gray-900 truncate">New Order: ${order.items[0]?.name || 'Item'}${order.items.length > 1 ? ` (+${order.items.length - 1})` : ''}</p>
                            <p class="text-gray-500 text-xs">${new Date(order.createdAt).toLocaleString()}</p>
                        `;
                        // MODIFIED: Add click handler to navigate to the order
                        item.onclick = () => window.location.href = `manage-orders.html`;
                         list.appendChild(item);
                    });
                }
                
                // Show/hide empty state
                if (count > 0) {
                     emptyState.classList.add('hidden');
                } else {
                    list.appendChild(emptyState); // Re-add empty state if no items
                    emptyState.classList.remove('hidden');
                }

                // Update badge visibility
                badge.classList.toggle('visible', count > 0);
                
            }, (error) => {
                console.error("Error fetching notifications:", error);
                 list.innerHTML = ''; // Clear list on error
                 emptyState.textContent = "Error loading notifications.";
                 list.appendChild(emptyState);
                 emptyState.classList.remove('hidden');
                 badge.classList.remove('visible');
            });
        }

        // --- Dashboard Stats Logic ---
        function loadDashboardStats() {
            // Stat 1: Total Users
            firebase.database().ref('users').on('value', (snapshot) => {
                let count = 0;
                if (snapshot.exists()) {
                    // MODIFIED: Filter out any non-student/admin roles if they exist
                    snapshot.forEach(child => {
                        if (child.val().role === 'student' || child.val().role === 'admin') {
                            count++;
                        }
                    });
                }
                document.getElementById('stat-total-users').textContent = count;
            });

            // Stat 2: Total Sales (sum of totalPrice from 'Completed' orders)
            // MODIFIED: Only count sales from 'Completed' orders
            firebase.database().ref('orders').orderByChild('status').equalTo('Completed').on('value', (snapshot) => {
                let totalSales = 0;
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        totalSales += childSnapshot.val().totalPrice || 0;
                    });
                }
                document.getElementById('stat-total-sales').textContent = `$${totalSales.toFixed(2)}`;
            });

            // Stat 3: Upcoming Events (count events >= today)
            const todayISO = new Date().toISOString().split('T')[0]; // Get YYYY-MM-DD
            firebase.database().ref('events').orderByChild('date').startAt(todayISO).on('value', (snapshot) => {
                const count = snapshot.exists() ? snapshot.numChildren() : 0;
                document.getElementById('stat-upcoming-events').textContent = count;
            });

            // Stat 4: Active Marketplace Items (count items with quantity > 0)
            firebase.database().ref('marketplace').orderByChild('quantity').startAt(1).on('value', (snapshot) => {
                const count = snapshot.exists() ? snapshot.numChildren() : 0;
                document.getElementById('stat-active-items').textContent = count;
            });
        }

        // --- Main Page Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loading');
            loadingOverlay.classList.remove('hidden'); // Show loading

            document.getElementById('hamburger-btn').addEventListener('click', () => {
                document.getElementById('admin-sidebar').classList.toggle('is-open');
                document.getElementById('admin-sidebar').classList.toggle('-translate-x-full'); // Adjust based on your mobile sidebar implementation
            });
            
            // Use native Firebase auth listener for reliability
            firebase.auth().onAuthStateChanged(async (user) => {
                if (!user) { 
                    window.location.href = '../login.html'; 
                    return; 
                }
                
                // Verify user role before proceeding
                try {
                    const roleSnapshot = await firebase.database().ref(`users/${user.uid}/role`).once('value');
                    const role = roleSnapshot.val();
                    
                    if (role !== 'admin') { 
                        console.warn("User is not an admin. Redirecting.");
                        await firebase.auth().signOut(); // Log out non-admins
                        window.location.href = '../login.html';
                        return; 
                    }
                    
                    // User is verified admin, initialize UI components
                    setupProfileDropdown(user); 
                    initNotifications(user);
                    loadDashboardStats(); 
                    
                } catch (error) {
                    console.error("Error verifying user role:", error);
                     // Redirect to login on error
                    window.location.href = '../login.html'; 
                } finally {
                     loadingOverlay.classList.add('hidden'); // Hide loading
                }
            });
        });
    </script>
</body>
</html>